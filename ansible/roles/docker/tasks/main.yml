- name: Install prerequisites
  apt:
    name: [ca-certificates, curl, gnupg]
    state: present
    update_cache: true

- name: Add Docker GPG key
  shell: |
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    chmod a+r /etc/apt/keyrings/docker.asc
  args:
    creates: /etc/apt/keyrings/docker.asc

- name: Remove conflicting Docker sources
  apt_repository:
    repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: absent

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    update_cache: true

- name: Install Docker
  apt:
    name: [docker-ce, docker-ce-cli, containerd.io]
    state: present

- name: Start and enable Docker
  service:
    name: docker
    state: started
    enabled: true

- name: Log into GHCR
  shell: echo "{{ ghcr_token }}" | docker login ghcr.io -u "{{ ghcr_user }}" --password-stdin

- name: Pull and run backend container
  shell: |
    docker pull ghcr.io/{{ ghcr_user }}/scenario-lab-api:{{ image_tag | default('latest') }}
    docker rm -f scenario-lab-api || true
    docker run -d \
      --name scenario-lab-api \
      --restart unless-stopped \
      -p 127.0.0.1:8080:8080 \
      ghcr.io/{{ ghcr_user }}/scenario-lab-api:{{ image_tag | default('latest') }}
